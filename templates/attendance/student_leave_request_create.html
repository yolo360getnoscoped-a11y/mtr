{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}ขอลาใหม่{% endblock %}

{% block extra_css %}
<style>
.leave-request-form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
}

.form-card {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-group input[type="file"] {
    padding: 0.5rem;
}

.form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #666;
    font-size: 0.875rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

.btn {
    padding: 0.75rem 2rem;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    display: inline-block;
}

.btn-primary {
    background-color: #0066cc;
    color: white;
}

.btn-primary:hover {
    background-color: #0052a3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="leave-request-form-container">
    <h1 class="page-title">ขอลาใหม่</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="margin-bottom: 1rem; padding: 1rem; border-radius: 4px; background-color: {% if message.tags == 'error' %}#f8d7da{% elif message.tags == 'success' %}#d4edda{% else %}#d1ecf1{% endif %}; color: {% if message.tags == 'error' %}#721c24{% elif message.tags == 'success' %}#155724{% else %}#0c5460{% endif %};">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="form-card">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="section" class="required-field">กลุ่มเรียน</label>
                <div style="position: relative;">
                    <input type="text" id="section_search" placeholder="ค้นหากลุ่มเรียน (รหัสวิชา, ชื่อวิชา, กลุ่มเรียน)" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                    <select id="section" name="section" required size="8" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                        <option value="">-- เลือกกลุ่มเรียน --</option>
                        {% for section in sections %}
                        <option value="{{ section.id }}" 
                            data-course-code="{{ section.course.course_code }}"
                            data-course-name="{{ section.course.course_name }}"
                            data-section-number="{{ section.section_number }}"
                            data-teacher-name="{% if section.teacher %}{{ section.teacher.get_full_name|default:section.teacher.username }}{% else %}ยังไม่กำหนดอาจารย์{% endif %}">
                            {{ section.course.course_code }} - {{ section.course.course_name }} (กลุ่ม {{ section.section_number }}) - อาจารย์: {% if section.teacher %}{{ section.teacher.get_full_name|default:section.teacher.username }}{% else %}ยังไม่กำหนดอาจารย์{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small id="section-help" style="color: #666; display: block; margin-top: 0.25rem;">ค้นหาและเลือกกลุ่มเรียนที่ต้องการลาจากรายการด้านบน</small>
                </div>
            </div>

            <div class="form-group">
                <label for="leave_date" class="required-field">วันที่ลา</label>
                <input type="date" id="leave_date" name="leave_date" required>
                <small>เลือกวันที่ต้องการลา</small>
            </div>

            <div class="form-group">
                <label for="leave_type" class="required-field">ประเภทการลา</label>
                <select id="leave_type" name="leave_type" required>
                    <option value="sick">ลาป่วย</option>
                    <option value="personal">ลากิจ</option>
                    <option value="other">อื่นๆ</option>
                </select>
            </div>

            <div class="form-group">
                <label for="reason" class="required-field">เหตุผลการลา</label>
                <textarea id="reason" name="reason" required placeholder="กรุณาระบุเหตุผลการลา"></textarea>
                <small>กรุณาระบุเหตุผลการลาอย่างชัดเจน</small>
            </div>

            <div class="form-group">
                <label for="supporting_document">เอกสารประกอบ (ถ้ามี)</label>
                <input type="file" id="supporting_document" name="supporting_document" accept=".pdf,.jpg,.jpeg,.png">
                <small>รองรับไฟล์ PDF, JPG, PNG (ไม่บังคับ)</small>
            </div>

            <div class="form-actions">
                <a href="{% url 'attendance:student_leave_request_list' %}" class="btn btn-secondary">ยกเลิก</a>
                <button type="submit" class="btn btn-primary">ส่งคำขอลา</button>
            </div>
        </form>
    </div>
</div>

<script>
// Set minimum date to today
document.addEventListener('DOMContentLoaded', function() {
    const leaveDateInput = document.getElementById('leave_date');
    const sectionSelect = document.getElementById('section');
    const sectionSearch = document.getElementById('section_search');
    const sectionHelp = document.getElementById('section-help');
    
    // Store all options for filtering
    const allOptions = Array.from(sectionSelect.options);
    
    if (leaveDateInput) {
        const today = new Date().toISOString().split('T')[0];
        leaveDateInput.setAttribute('min', today);
    }
    
    // Sort options alphabetically by course code
    function sortOptions() {
        const options = Array.from(sectionSelect.options);
        options.shift(); // Remove first option (placeholder)
        
        options.sort((a, b) => {
            const codeA = a.getAttribute('data-course-code') || '';
            const codeB = b.getAttribute('data-course-code') || '';
            return codeA.localeCompare(codeB, 'th', { numeric: true });
        });
        
        // Clear and re-add sorted options
        sectionSelect.innerHTML = '<option value="">-- เลือกกลุ่มเรียน --</option>';
        options.forEach(option => {
            sectionSelect.appendChild(option);
        });
    }
    
    // Initial sort
    sortOptions();
    updateSectionCount();
    
    // Search functionality
    if (sectionSearch) {
        sectionSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            // Show all options
            allOptions.forEach(option => {
                if (option.value === '') {
                    option.style.display = '';
                    return;
                }
                
                const courseCode = (option.getAttribute('data-course-code') || '').toLowerCase();
                const courseName = (option.getAttribute('data-course-name') || '').toLowerCase();
                const sectionNumber = (option.getAttribute('data-section-number') || '').toLowerCase();
                const teacherName = (option.getAttribute('data-teacher-name') || '').toLowerCase();
                
                const searchText = `${courseCode} ${courseName} ${sectionNumber} ${teacherName}`;
                
                if (searchText.includes(searchTerm)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            updateSectionCount();
        });
    }
    
    function updateSectionCount() {
        const visibleOptions = Array.from(sectionSelect.options).filter(opt => {
            return opt.value !== '' && opt.style.display !== 'none';
        });
        
        if (sectionHelp) {
            if (visibleOptions.length === 0 && sectionSearch.value.trim() !== '') {
                sectionHelp.textContent = 'ไม่พบกลุ่มเรียนที่ตรงกับการค้นหา';
                sectionHelp.style.color = '#dc3545';
            } else if (visibleOptions.length === 1) {
                sectionHelp.textContent = `พบ 1 กลุ่มเรียน`;
                sectionHelp.style.color = '#666';
            } else {
                sectionHelp.textContent = `พบ ${visibleOptions.length} กลุ่มเรียน (สามารถค้นหาได้)`;
                sectionHelp.style.color = '#666';
            }
        }
    }
    
    // Update count when selection changes
    sectionSelect.addEventListener('change', function() {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            const teacherName = selectedOption.getAttribute('data-teacher-name');
            if (sectionHelp) {
                sectionHelp.textContent = `เลือกแล้ว: จะส่งคำขอลาไปยัง ${teacherName}`;
                sectionHelp.style.color = '#0066cc';
            }
        } else {
            updateSectionCount();
        }
    });
});
</script>
{% endblock %}

