{% extends 'base_dashboard.html' %}

{% block title %}จัดการนักศึกษา - {{ course.course_code }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>จัดการนักศึกษา</h1>
    <p style="color: #666; margin-top: 0.5rem;">{{ course.course_code }} - {{ course.course_name }}</p>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="margin-bottom: 1rem; padding: 1rem; border-radius: 4px; background-color: {% if message.tags == 'error' %}#f8d7da{% elif message.tags == 'success' %}#d4edda{% else %}#d1ecf1{% endif %}; color: {% if message.tags == 'error' %}#721c24{% elif message.tags == 'success' %}#155724{% else %}#0c5460{% endif %};">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Add Student Form -->
<div class="form-container" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1.5rem; color: #333; border-bottom: 2px solid #0066cc; padding-bottom: 0.5rem;">เพิ่มนักศึกษา</h2>
    <form method="post" class="form">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="student_id">เลือกนักศึกษา</label>
                <select id="student_id" name="student_id" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- เลือกนักศึกษา --</option>
                    {% for student in available_students %}
                    <option value="{{ student.id }}">
                        {{ student.get_full_name|default:student.username }}
                        {% if student.profile and student.profile.student_id %} ({{ student.profile.student_id }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="section_id">เลือกกลุ่มเรียน</label>
                <select id="section_id" name="section_id" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- เลือกกลุ่มเรียน --</option>
                    {% for section in sections %}
                    <option value="{{ section.id }}">กลุ่ม {{ section.section_number }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 2rem;">เพิ่ม</button>
        </div>
    </form>
</div>

<!-- Search and Filter -->
<div class="filter-container" style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <form method="get" style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <label for="search" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ค้นหา</label>
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="ค้นหาจากชื่อ, รหัสนักศึกษา" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="min-width: 150px;">
            <label for="section_filter" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">กลุ่มเรียน</label>
            <select id="section_filter" name="section_id" onchange="this.form.submit()" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">ทั้งหมด</option>
                {% for section in sections %}
                <option value="{{ section.id }}" {% if selected_section == section.id|stringformat:"s" %}selected{% endif %}>
                    กลุ่ม {{ section.section_number }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">ค้นหา</button>
            {% if search_query or selected_section %}
            <a href="{% url 'academic:manage_course_students' course.id %}" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; margin-left: 0.5rem;">ล้าง</a>
            {% endif %}
        </div>
    </form>
</div>

<!-- Students List -->
<div class="table-container" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0; color: #333; border-bottom: 2px solid #0066cc; padding-bottom: 0.5rem;">
            รายชื่อนักศึกษา ({{ enrollments.count }} คน)
        </h2>
    </div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>ลำดับ</th>
                <th>ชื่อ-นามสกุล</th>
                <th>รหัสนักศึกษา</th>
                <th>กลุ่มเรียน</th>
                <th>สถานะ</th>
                <th>วันที่ลงทะเบียน</th>
                <th>จัดการ</th>
            </tr>
        </thead>
        <tbody>
            {% for enrollment in enrollments %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ enrollment.student.get_full_name|default:enrollment.student.username }}</td>
                <td>
                    {% if enrollment.student.profile and enrollment.student.profile.student_id %}
                        {{ enrollment.student.profile.student_id }}
                    {% else %}
                        {{ enrollment.student.username }}
                    {% endif %}
                </td>
                <td>กลุ่ม {{ enrollment.section.section_number }}</td>
                <td>
                    <span class="status-badge status-{{ enrollment.status }}">
                        {{ enrollment.get_status_display }}
                    </span>
                </td>
                <td>{{ enrollment.enrolled_at|date:"d/m/Y H:i" }}</td>
                <td>
                    <button onclick="openEditModal({{ enrollment.id }}, '{{ enrollment.student.get_full_name|default:enrollment.student.username }}', {{ enrollment.section.id }}, '{{ enrollment.status }}')" class="btn btn-sm btn-edit">แก้ไข</button>
                    <form method="post" style="display: inline;" onsubmit="return confirm('ยืนยันการลบนักศึกษา {{ enrollment.student.get_full_name|default:enrollment.student.username }} ออกจากรายวิชา?')">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="remove">
                        <input type="hidden" name="enrollment_id" value="{{ enrollment.id }}">
                        <button type="submit" class="btn btn-sm" style="background: #dc3545; color: white;">ลบ</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center" style="padding: 2rem; color: #999;">
                    {% if search_query or selected_section %}
                        ไม่พบข้อมูลที่ค้นหา
                    {% else %}
                        ยังไม่มีนักศึกษาลงทะเบียนในรายวิชานี้
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="form-actions" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
    <a href="{% url 'academic:course_detail' course.id %}" class="btn btn-secondary">กลับ</a>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: #333;">แก้ไขข้อมูลนักศึกษา</h3>
        <form method="post" id="editForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="enrollment_id" id="edit_enrollment_id">
            
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="edit_student_name" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ชื่อนักศึกษา</label>
                <input type="text" id="edit_student_name" readonly style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
            </div>
            
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="edit_section_id" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">กลุ่มเรียน</label>
                <select id="edit_section_id" name="section_id" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    {% for section in sections %}
                    <option value="{{ section.id }}">กลุ่ม {{ section.section_number }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="edit_status" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">สถานะ</label>
                <select id="edit_status" name="status" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="pending">รอลงทะเบียน</option>
                    <option value="enrolled">ลงทะเบียน</option>
                    <option value="withdrawn">ถอน</option>
                    <option value="completed">เรียนจบ</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeEditModal()" class="btn btn-secondary">ยกเลิก</button>
                <button type="submit" class="btn btn-primary">บันทึก</button>
            </div>
        </form>
    </div>
</div>

<style>
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-enrolled {
    background: #d4edda;
    color: #155724;
}

.status-withdrawn {
    background: #f8d7da;
    color: #721c24;
}

.status-completed {
    background: #d1ecf1;
    color: #0c5460;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffc107;
}
</style>

<script>
function openEditModal(enrollmentId, studentName, sectionId, status) {
    document.getElementById('edit_enrollment_id').value = enrollmentId;
    document.getElementById('edit_student_name').value = studentName;
    document.getElementById('edit_section_id').value = sectionId;
    document.getElementById('edit_status').value = status;
    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>
{% endblock %}

