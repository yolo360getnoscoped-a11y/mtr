{% extends 'base_dashboard.html' %}

{% block title %}จัดการผู้ใช้{% endblock %}

{% block content %}
<div class="page-header">
    <h1>จัดการผู้ใช้</h1>
    <a href="{% url 'accounts:user_add' %}" class="btn btn-primary">เพิ่มผู้ใช้ใหม่</a>
</div>

<!-- Filter and Search -->
<div class="form-container" style="margin-bottom: 2rem;">
    <form method="get" class="form" style="display: flex; gap: 1rem; align-items: flex-end;">
        <div class="form-group" style="flex: 1;">
            <label for="search">ค้นหา</label>
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="ค้นหาจากชื่อผู้ใช้, อีเมล, ชื่อ-นามสกุล">
        </div>
        <div class="form-group">
            <label for="role">บทบาท</label>
            <select id="role" name="role">
                <option value="">ทั้งหมด</option>
                <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>ผู้ดูแลระบบ</option>
                <option value="teacher" {% if role_filter == 'teacher' %}selected{% endif %}>อาจารย์</option>
                <option value="student" {% if role_filter == 'student' %}selected{% endif %}>นักศึกษา</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">ค้นหา</button>
        {% if role_filter or search_query %}
        <a href="{% url 'accounts:user_list' %}" class="btn btn-secondary">ล้าง</a>
        {% endif %}
    </form>
</div>

<!-- CSRF Token for JavaScript -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<!-- Batch Actions Toolbar -->
<div id="batch-actions-toolbar" class="batch-actions-toolbar" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; align-items: center; gap: 1rem;">
    <span id="selected-count" style="font-weight: 600; color: #333;">0</span> <span>รายการที่เลือก</span>
    <button type="button" class="btn btn-danger" onclick="batchDelete()" style="background: #dc3545; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-trash-alt"></i> ลบที่เลือก
    </button>
    <button type="button" class="btn btn-secondary" onclick="clearSelection()" style="background: #6c757d; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-times"></i> ยกเลิก
    </button>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 50px;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()" style="cursor: pointer;">
                </th>
                <th>ชื่อผู้ใช้</th>
                <th>ชื่อ-นามสกุล</th>
                <th>อีเมล</th>
                <th>บทบาท</th>
                <th>รหัส/ID</th>
                <th>จัดการ</th>
            </tr>
        </thead>
        <tbody>
            {% for user_obj in users %}
            <tr>
                <td>
                    {% if user_obj != user %}
                    <input type="checkbox" class="user-checkbox" value="{{ user_obj.id }}" onchange="updateBatchActions()" style="cursor: pointer;">
                    {% endif %}
                </td>
                <td>{{ user_obj.username }}</td>
                <td>{{ user_obj.get_full_name|default:"-" }}</td>
                <td>{{ user_obj.email }}</td>
                <td>
                    <span class="badge badge-{{ user_obj.role }}">
                        {{ user_obj.get_role_display }}
                    </span>
                </td>
                <td>
                    {% if user_obj.is_student and user_obj.student_profile %}
                        {{ user_obj.student_profile.student_id }}
                    {% elif user_obj.is_teacher and user_obj.teacher_profile %}
                        {{ user_obj.teacher_profile.employee_id|default:"-" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'accounts:user_edit' user_obj.id %}" class="btn btn-sm btn-edit">แก้ไข</a>
                    {% if user_obj != user %}
                    <a href="{% url 'accounts:user_delete' user_obj.id %}" class="btn btn-sm" style="background: #dc3545; color: white;" onclick="return confirm('คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ {{ user_obj.username }}?')">ลบ</a>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">ไม่พบข้อมูลผู้ใช้</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% block extra_js %}
<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBatchActions();
}

function updateBatchActions() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const toolbar = document.getElementById('batch-actions-toolbar');
    const selectedCount = document.getElementById('selected-count');
    
    if (checkboxes.length > 0) {
        toolbar.style.display = 'flex';
        selectedCount.textContent = checkboxes.length;
    } else {
        toolbar.style.display = 'none';
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.user-checkbox');
    const selectAll = document.getElementById('select-all');
    if (allCheckboxes.length > 0) {
        selectAll.checked = checkboxes.length === allCheckboxes.length;
    }
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    const selectAll = document.getElementById('select-all');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAll.checked = false;
    
    updateBatchActions();
}

function batchDelete() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('กรุณาเลือกผู้ใช้ที่ต้องการลบ');
        return;
    }
    
    const confirmMessage = `คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ ${selectedIds.length} รายการ?`;
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "accounts:batch_delete_users" %}';
    
    // Get CSRF token - try multiple sources
    let csrftoken = null;
    
    // First try: hidden input field
    const csrfTokenInput = document.getElementById('csrf-token');
    if (csrfTokenInput) {
        csrftoken = csrfTokenInput.value;
    }
    
    // Second try: meta tag
    if (!csrftoken) {
        const metaTag = document.querySelector('meta[name=csrf-token]');
        if (metaTag) {
            csrftoken = metaTag.getAttribute('content');
        }
    }
    
    // Third try: cookie
    if (!csrftoken) {
        csrftoken = getCookie('csrftoken');
    }
    
    // Fourth try: any existing form on the page
    if (!csrftoken) {
        const existingForm = document.querySelector('form');
        if (existingForm) {
            const existingToken = existingForm.querySelector('input[name=csrfmiddlewaretoken]');
            if (existingToken) {
                csrftoken = existingToken.value;
            }
        }
    }
    
    if (!csrftoken) {
        alert('ไม่สามารถรับ CSRF token ได้ กรุณารีโหลดหน้าเว็บ');
        return;
    }
    
    // Add CSRF token to form
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrftoken;
    form.appendChild(csrfInput);
    
    // Add user IDs
    selectedIds.forEach(userId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_ids';
        input.value = userId;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

<style>
.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
}

.badge-admin {
    background: #dc3545;
    color: white;
}

.badge-teacher {
    background: #0066cc;
    color: white;
}

.badge-student {
    background: #28a745;
    color: white;
}

.batch-actions-toolbar {
    display: none;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 4px;
    align-items: center;
    gap: 1rem;
}

.batch-actions-toolbar.show {
    display: flex;
}
</style>
{% endblock %}

